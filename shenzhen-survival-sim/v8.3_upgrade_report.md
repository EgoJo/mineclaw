# 深圳生存模拟 v8.3 升级报告

## 升级概述

v8.3 是对 v8.2 系统的深度优化，针对运行数据分析中发现的五大核心问题进行了修复。本次升级已完成代码修改、语法校验、系统重启和端到端验证。

---

## 问题诊断与修复

### 1. 情绪系统重塑 — "全员抑郁"问题

**问题**：v8.2 中 happiness 的衰减速率为 -5/tick，而增益最多 +2，导致所有 Bot 的 happiness 永远为 0。

**修复**：
- happiness 衰减从 `-5` 降低到 `-1`
- sadness 衰减从 `-2` 改为 `-3`（更快恢复）
- 完成任务的 happiness 奖励从 `+2` 提升到 `+10`
- 社交行为的 happiness 奖励从 `+3` 提升到 `+8`
- 孤独感增长从 `+3` 降低到 `+2`，有人时减少从 `-2` 增加到 `-5`

**验证结果**：✅ 所有 Bot 的 happiness 在 64-84 之间，情绪分布自然合理。

| Bot | Happiness (v8.2) | Happiness (v8.3) | 变化 |
|-----|:-:|:-:|:-:|
| 李浩然 | 0 | 76 | +76 |
| 王雪 | 0 | 74 | +74 |
| 张伟 | 0 | 84 | +84 |
| 周建国 | 0 | 84 | +84 |
| 吴秀英 | 0 | 82 | +82 |

---

### 2. 状态同步总线 — "集体失忆"问题

**问题**：v8.2 中 bot_agent 的核心记忆、价值观、情感纽带、近期行动等数据无法同步到 world_engine，导致 API 返回全部为空。

**修复**：
- 新增 `/bot/{bot_id}/sync_state` 统一同步端点
- bot_agent 每次心跳后自动调用同步总线，上传完整内心状态
- detail 端点增加 `long_term_goal`、`narrative_summary`、`recent_actions_synced`、`pending_reply_to` 字段

**验证结果**：✅ 所有 Bot 的 `recent_actions_synced` 均为 5 条，同步正常工作。

---

### 3. 双向对话机制 — "尬聊循环"问题

**问题**：v8.2 中 Bot A 对 Bot B 说话后，B 不知道 A 说了什么，无法回应，导致对话变成单向广播。

**修复**：
- 当 Bot A 对 Bot B 说话时，在 B 的状态中设置 `pending_reply_to` 字段
- bot_agent 在心跳时检查 `pending_reply_to`，如果有值则在 prompt 中强提示回应
- 回应后通过 sync_state 清除 pending_reply

**验证结果**：✅ 李浩然和王雪形成了 3 轮真实的双向对话：
1. 王雪 → 李浩然："你好，我想了解一些本地资源和信息"
2. 李浩然 → 王雪："聊聊本地资源和找工作的情况"（回应 pending_reply）
3. 王雪 → 李浩然："试探他对本地投资和创业项目的了解情况"

---

### 4. 叙事摘要与长期目标 — "行为固化"问题

**问题**：v8.2 中 Bot 缺乏长期目标，被短期情绪驱动，行为模式单一。

**修复**：
- 反思系统新增 `long_term_goal` 和 `narrative_summary` 字段
- 反思 prompt 引导 LLM 基于性格和经历设定具体的长期目标
- 决策 prompt 中展示长期目标，引导行为朝目标方向发展

**验证结果**：✅ 所有 10 个 Bot 均已生成叙事摘要：

| Bot | 叙事摘要 |
|-----|---------|
| 李浩然 | 在深圳城中村探索创业和技术的可能性，保持低调但积极应对未来 |
| 王雪 | 在南山科技氛围中积极探索人脉和资源，努力寻找合作机会 |
| 张伟 | 在东门城中村努力找活干，靠勤劳维持家庭生活 |
| 陈静 | 在深圳湾公园用艺术寻找归属感，期待在异乡用创作实现梦想 |
| 赵磊 | 热爱享受生活，喜欢在电子市场炫耀，追求面子和朋友的认可 |
| 刘悦 | 在福田CBD积极探索创业资源，渴望拓展人脉和行业信息 |
| 周建国 | 在深圳华强北摸索人脉和商机，努力拓展关系网以谋求更大突破 |
| 吴秀英 | 在城中村努力维持家庭生计，关注邻里关系，渴望家庭安稳 |
| 林枫 | 在东门老街的街头用音乐追寻梦想，生活虽艰难但充满希望 |
| 苏小小 | 在深圳追逐流量和关注，享受阳光和颜值带来的自信 |

> 长期目标尚未触发（第一次反思时经历太少，LLM 判断暂不设定），随着经历积累会自然生成。

---

### 5. 反重复升级与鲁棒性

**问题**：v8.2 的反重复机制只记录行动前 20 字符，无法区分"和苏小小聊天"的不同内容。

**修复**：
- 反重复键升级为 `行动[:15]|结果[:15]` 联合键
- 记录窗口从 5 条扩大到 8 条
- prompt 中展示最近 5 条行动（含结果摘要），措辞从"尽量不要"改为"严禁重复"
- LLM 返回的 JSON 解析使用正则表达式，更鲁棒

**验证结果**：✅ 行为类型分布多样化：

| 行为类型 | 次数 |
|---------|:---:|
| 自由行动 | 11 |
| 对话 | 21 |
| 移动 | 4 |
| 吃饭 | 6 |
| 工作 | 2 |
| 朋友圈 | 2 |
| 刷热搜 | 1 |

---

## 系统稳定性

- **核心错误**：0（唯一的错误是拍照 API 额度用完，非系统问题）
- **同步超时**：仅在第一个 tick 时出现（10 个 Bot 同时启动导致拥堵），后续全部正常
- **所有 10 个 Bot 进程**：运行正常
- **世界引擎**：运行正常，Tick 正常推进

---

## 当前运行状态

- **版本**：v8.3
- **Tick**：5（第1天 11:00）
- **存活 Bot**：10/10
- **端口**：8000

---

## 后续可优化方向

1. **长期目标触发**：当前 LLM 在首次反思时倾向于不设定目标，可考虑在初始化时为每个 Bot 预设一个初始目标
2. **核心记忆积累**：随着运行时间增加，核心记忆会自然积累
3. **Dashboard 恢复**：当前 Dashboard 未启动，可后续恢复
4. **同步超时优化**：可为 Bot 启动添加随机延迟，避免首 tick 拥堵
